"""System and host asset models"""

from dataclasses import dataclass
from enum import Enum
from typing import List, Optional

from pentest_asset_model.models.base import (
    Asset,
    AssetType,
    RelationshipType,
)


class OSType(Enum):
    """Operating system types"""
    WINDOWS = "windows"
    LINUX = "linux"
    MACOS = "macos"
    BSD = "bsd"
    UNIX = "unix"
    IOS = "ios"
    ANDROID = "android"
    OTHER = "other"
    UNKNOWN = "unknown"


class Architecture(Enum):
    """System architectures"""
    X86 = "x86"
    X64 = "x64"
    ARM = "arm"
    ARM64 = "arm64"
    MIPS = "mips"
    POWERPC = "powerpc"


class VirtualType(Enum):
    """Virtualization types"""
    PHYSICAL = "physical"
    VMWARE = "vmware"
    HYPERV = "hyperv"
    KVM = "kvm"
    DOCKER = "docker"
    XEN = "xen"
    AWS_EC2 = "aws_ec2"
    AZURE_VM = "azure_vm"
    GCP_COMPUTE = "gcp_compute"


class SystemRole(Enum):
    """System roles"""
    WORKSTATION = "workstation"
    SERVER = "server"
    DOMAIN_CONTROLLER = "domain_controller"
    ROUTER = "router"
    SWITCH = "switch"
    FIREWALL = "firewall"
    IOT = "iot"
    PRINTER = "printer"
    NAS = "nas"
    LOAD_BALANCER = "load_balancer"
    PROXY = "proxy"


@dataclass
class NetworkInterface:
    """Represents a network interface"""
    interface_name: str
    ip_address: str
    mac_address: Optional[str] = None
    netmask: Optional[str] = None
    gateway: Optional[str] = None
    ipv6_address: Optional[str] = None
    vlan_id: Optional[int] = None

    def to_dict(self):
        return {
            "interface_name": self.interface_name,
            "ip_address": self.ip_address,
            "mac_address": self.mac_address,
            "netmask": self.netmask,
            "gateway": self.gateway,
            "ipv6_address": self.ipv6_address,
            "vlan_id": self.vlan_id,
        }


@dataclass
class Software:
    """Represents installed software"""
    name: str
    version: Optional[str] = None
    vendor: Optional[str] = None
    install_date: Optional[str] = None
    vulnerable: bool = False
    cve_list: List[str] = None

    def __post_init__(self):
        if self.cve_list is None:
            self.cve_list = []

    def to_dict(self):
        return {
            "name": self.name,
            "version": self.version,
            "vendor": self.vendor,
            "install_date": self.install_date,
            "vulnerable": self.vulnerable,
            "cve_list": self.cve_list,
        }


@dataclass
class Host(Asset):
    """Represents a host/system"""

    def __init__(
        self,
        id: str,
        hostname: str,
        ip: str,
        os_type: OSType = OSType.UNKNOWN,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.HOST,
            name=hostname,
            **kwargs
        )

        # Initialize host-specific properties
        self.properties.update({
            "hostname": hostname,
            "fqdn": hostname,
            "ip_addresses": [ip] if ip else [],
            "network_interfaces": [],
            "os_type": os_type.value if isinstance(os_type, OSType) else os_type,
            "os_version": None,
            "os_patch_level": None,
            "architecture": Architecture.X64.value,
            "virtual_type": VirtualType.PHYSICAL.value,
            "domain_member": False,
            "domain_name": None,
            "installed_software": [],
            "open_ports": [],
            "listening_services": [],
            "local_users": [],
            "last_boot": None,
            "system_role": SystemRole.WORKSTATION.value,
            "antivirus": None,
            "edr_installed": False,
            "patches_missing": [],
            "vulnerabilities": [],
        })

    def add_network_interface(self, interface: NetworkInterface):
        """Add a network interface"""
        self.properties.setdefault("network_interfaces", []).append(interface.to_dict())
        if interface.ip_address not in self.properties["ip_addresses"]:
            self.properties["ip_addresses"].append(interface.ip_address)

    def add_software(self, software: Software):
        """Add installed software"""
        self.properties.setdefault("installed_software", []).append(software.to_dict())

    def add_open_port(self, port: int, protocol: str = "tcp", service: str = None):
        """Add an open port"""
        port_info = {
            "port": port,
            "protocol": protocol,
            "service": service
        }
        if port_info not in self.properties.get("open_ports", []):
            self.properties.setdefault("open_ports", []).append(port_info)

    def add_service(self, service_id: str):
        """Add a service relationship"""
        self.add_relationship(RelationshipType.RUNS_ON, service_id)
        if service_id not in self.properties.get("listening_services", []):
            self.properties.setdefault("listening_services", []).append(service_id)

    def add_user(self, user_id: str):
        """Add a local user"""
        if user_id not in self.properties.get("local_users", []):
            self.properties.setdefault("local_users", []).append(user_id)

    def set_domain_member(self, domain_name: str):
        """Mark as domain member"""
        self.properties["domain_member"] = True
        self.properties["domain_name"] = domain_name

    def set_system_role(self, role: SystemRole):
        """Set the system role"""
        if isinstance(role, str):
            role = SystemRole(role)
        self.properties["system_role"] = role.value

    def set_virtual_type(self, virtual_type: VirtualType):
        """Set virtualization type"""
        if isinstance(virtual_type, str):
            virtual_type = VirtualType(virtual_type)
        self.properties["virtual_type"] = virtual_type.value

    def add_vulnerability(self, cve: str, severity: str, description: str = ""):
        """Add a vulnerability"""
        vuln = {
            "cve": cve,
            "severity": severity,
            "description": description
        }
        self.properties.setdefault("vulnerabilities", []).append(vuln)

    def is_windows(self) -> bool:
        """Check if host is Windows"""
        return self.properties.get("os_type") == OSType.WINDOWS.value

    def is_linux(self) -> bool:
        """Check if host is Linux"""
        return self.properties.get("os_type") == OSType.LINUX.value

    def is_domain_joined(self) -> bool:
        """Check if host is domain-joined"""
        return self.properties.get("domain_member", False)


@dataclass
class DomainController(Host):
    """Represents a domain controller (extends Host)"""

    def __init__(
        self,
        id: str,
        hostname: str,
        ip: str,
        domain_name: str,
        **kwargs
    ):
        super().__init__(
            id=id,
            hostname=hostname,
            ip=ip,
            os_type=OSType.WINDOWS,
            **kwargs
        )

        self.asset_type = AssetType.DOMAIN_CONTROLLER
        self.properties.update({
            "system_role": SystemRole.DOMAIN_CONTROLLER.value,
            "forest_name": domain_name,
            "domain_name": domain_name,
            "domain_level": None,
            "fsmo_roles": [],
            "trust_relationships": [],
            "gpo_count": 0,
            "user_count": 0,
            "computer_count": 0,
            "ou_structure": [],
            "replication_partners": [],
        })

    def add_fsmo_role(self, role: str):
        """Add FSMO role"""
        roles = self.properties.get("fsmo_roles", [])
        if role not in roles:
            roles.append(role)
            self.properties["fsmo_roles"] = roles

    def add_trust(self, trusted_domain: str, trust_type: str, direction: str):
        """Add trust relationship"""
        trust = {
            "trusted_domain": trusted_domain,
            "trust_type": trust_type,
            "direction": direction
        }
        self.properties.setdefault("trust_relationships", []).append(trust)

    def set_domain_stats(self, users: int, computers: int, gpos: int):
        """Set domain statistics"""
        self.properties.update({
            "user_count": users,
            "computer_count": computers,
            "gpo_count": gpos
        })

    def add_ou(self, ou_name: str, ou_path: str):
        """Add organizational unit"""
        ou = {
            "name": ou_name,
            "path": ou_path
        }
        self.properties.setdefault("ou_structure", []).append(ou)
