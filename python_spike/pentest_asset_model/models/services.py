"""Service and application asset models"""

from dataclasses import dataclass
from enum import Enum
from typing import Optional

from pentest_asset_model.models.base import (
    Asset,
    AssetType,
    RelationshipType,
)


class Protocol(Enum):
    """Network protocols"""
    TCP = "tcp"
    UDP = "udp"
    ICMP = "icmp"
    SCTP = "sctp"


class ServiceState(Enum):
    """Service states"""
    OPEN = "open"
    CLOSED = "closed"
    FILTERED = "filtered"
    OPEN_FILTERED = "open|filtered"


class AuthMethod(Enum):
    """Authentication methods"""
    NONE = "none"
    BASIC = "basic"
    NTLM = "ntlm"
    KERBEROS = "kerberos"
    CERTIFICATE = "certificate"
    API_KEY = "api_key"
    OAUTH = "oauth"
    OAUTH2 = "oauth2"
    SAML = "saml"
    LDAP = "ldap"
    JWT = "jwt"
    BEARER = "bearer"


class ApplicationType(Enum):
    """Application types"""
    WEB = "web"
    DESKTOP = "desktop"
    MOBILE = "mobile"
    API = "api"
    DATABASE = "database"
    MIDDLEWARE = "middleware"


class DeploymentType(Enum):
    """Deployment types"""
    ON_PREM = "on_prem"
    CLOUD = "cloud"
    HYBRID = "hybrid"
    SAAS = "saas"


class HTTPMethod(Enum):
    """HTTP methods"""
    GET = "get"
    POST = "post"
    PUT = "put"
    DELETE = "delete"
    PATCH = "patch"
    OPTIONS = "options"
    HEAD = "head"


@dataclass
class Service(Asset):
    """Represents a network service"""

    def __init__(
        self,
        id: str,
        name: str,
        port: int,
        protocol: Protocol = Protocol.TCP,
        host_id: Optional[str] = None,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.SERVICE,
            name=name,
            **kwargs
        )

        # Initialize service-specific properties
        self.properties.update({
            "port": port,
            "protocol": protocol.value if isinstance(protocol, Protocol) else protocol,
            "service_type": name,
            "version": None,
            "banner": None,
            "state": ServiceState.OPEN.value,
            "auth_required": False,
            "auth_methods": [],
            "encryption": False,
            "tls_version": None,
            "supported_ciphers": [],
            "host_id": host_id,
            "vulnerabilities": [],
            "tested": False,
            "exploited": False,
        })

        # Add relationship to host if provided
        if host_id:
            self.add_relationship(RelationshipType.RUNS_ON, host_id)

    def set_version(self, version: str, banner: str = None):
        """Set service version and banner"""
        self.properties["version"] = version
        if banner:
            self.properties["banner"] = banner

    def add_auth_method(self, method: AuthMethod):
        """Add authentication method"""
        if isinstance(method, str):
            method = AuthMethod(method)
        methods = self.properties.get("auth_methods", [])
        if method.value not in methods:
            methods.append(method.value)
            self.properties["auth_methods"] = methods
        self.properties["auth_required"] = True

    def enable_encryption(self, tls_version: str = None):
        """Enable encryption"""
        self.properties["encryption"] = True
        if tls_version:
            self.properties["tls_version"] = tls_version

    def add_cipher(self, cipher: str):
        """Add supported cipher"""
        ciphers = self.properties.get("supported_ciphers", [])
        if cipher not in ciphers:
            ciphers.append(cipher)
            self.properties["supported_ciphers"] = ciphers

    def add_vulnerability(self, cve: str, severity: str, description: str = ""):
        """Add vulnerability"""
        vuln = {
            "cve": cve,
            "severity": severity,
            "description": description
        }
        self.properties.setdefault("vulnerabilities", []).append(vuln)

    def mark_tested(self):
        """Mark service as tested"""
        self.properties["tested"] = True

    def mark_exploited(self):
        """Mark service as exploited"""
        self.properties["exploited"] = True
        self.transition_state(self.lifecycle_state, "Service exploited")


@dataclass
class Application(Asset):
    """Represents an application"""

    def __init__(
        self,
        id: str,
        name: str,
        app_type: ApplicationType,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.APPLICATION,
            name=name,
            **kwargs
        )

        # Initialize application-specific properties
        self.properties.update({
            "type": app_type.value if isinstance(app_type, ApplicationType) else app_type,
            "version": None,
            "framework": None,
            "deployment_type": DeploymentType.ON_PREM.value,
            "url": None,
            "authentication_type": AuthMethod.NONE.value,
            "session_management": None,
            "api_endpoints": [],
            "data_stores": [],
            "third_party_integrations": [],
            "vulnerabilities": [],
            "authentication_bypass": False,
            "authorization_issues": [],
            "injection_vulnerabilities": [],
        })

    def set_framework(self, framework: str, version: str = None):
        """Set application framework"""
        self.properties["framework"] = framework
        if version:
            self.properties["version"] = version

    def set_url(self, url: str):
        """Set application URL"""
        self.properties["url"] = url

    def set_authentication(self, auth_type: AuthMethod):
        """Set authentication type"""
        if isinstance(auth_type, str):
            auth_type = AuthMethod(auth_type)
        self.properties["authentication_type"] = auth_type.value

    def add_api_endpoint(self, endpoint_id: str):
        """Add API endpoint"""
        self.add_relationship(RelationshipType.EXPOSES, endpoint_id)
        if endpoint_id not in self.properties.get("api_endpoints", []):
            self.properties.setdefault("api_endpoints", []).append(endpoint_id)

    def add_datastore(self, datastore_id: str):
        """Add data store"""
        self.add_relationship(RelationshipType.USES, datastore_id)
        if datastore_id not in self.properties.get("data_stores", []):
            self.properties.setdefault("data_stores", []).append(datastore_id)

    def add_integration(self, integration: str):
        """Add third-party integration"""
        integrations = self.properties.get("third_party_integrations", [])
        if integration not in integrations:
            integrations.append(integration)
            self.properties["third_party_integrations"] = integrations

    def add_vulnerability(self, vuln_type: str, severity: str, description: str = ""):
        """Add vulnerability"""
        vuln = {
            "type": vuln_type,
            "severity": severity,
            "description": description
        }
        self.properties.setdefault("vulnerabilities", []).append(vuln)


@dataclass
class APIEndpoint(Asset):
    """Represents an API endpoint"""

    def __init__(
        self,
        id: str,
        url_pattern: str,
        method: HTTPMethod,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.API_ENDPOINT,
            name=f"{method.value.upper()} {url_pattern}",
            **kwargs
        )

        # Initialize API endpoint properties
        self.properties.update({
            "url_pattern": url_pattern,
            "method": method.value if isinstance(method, HTTPMethod) else method,
            "auth_required": False,
            "auth_type": AuthMethod.NONE.value,
            "rate_limit": None,
            "version": None,
            "documentation_url": None,
            "request_schema": None,
            "response_schema": None,
            "discovered_parameters": [],
            "parameter_tampering_tested": False,
            "injection_tested": False,
            "auth_bypass_tested": False,
        })

    def set_auth(self, auth_type: AuthMethod):
        """Set authentication requirements"""
        if isinstance(auth_type, str):
            auth_type = AuthMethod(auth_type)
        self.properties["auth_required"] = True
        self.properties["auth_type"] = auth_type.value

    def set_rate_limit(self, rate_limit: str):
        """Set rate limit"""
        self.properties["rate_limit"] = rate_limit

    def add_parameter(self, param_name: str, param_type: str = "string"):
        """Add discovered parameter"""
        param = {
            "name": param_name,
            "type": param_type
        }
        params = self.properties.get("discovered_parameters", [])
        if param not in params:
            params.append(param)
            self.properties["discovered_parameters"] = params

    def set_schemas(self, request_schema: dict = None, response_schema: dict = None):
        """Set request/response schemas"""
        if request_schema:
            self.properties["request_schema"] = request_schema
        if response_schema:
            self.properties["response_schema"] = response_schema

    def mark_tested(self, test_type: str):
        """Mark specific test as completed"""
        test_key = f"{test_type}_tested"
        if test_key in self.properties:
            self.properties[test_key] = True
