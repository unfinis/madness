"""Data storage asset models"""

from dataclasses import dataclass
from enum import Enum
from typing import Dict, List

from pentest_asset_model.models.base import (
    Asset,
    AssetType,
    RelationshipType,
)


class DatabaseType(Enum):
    """Database types"""
    MYSQL = "mysql"
    POSTGRESQL = "postgresql"
    MSSQL = "mssql"
    ORACLE = "oracle"
    MONGODB = "mongodb"
    REDIS = "redis"
    ELASTICSEARCH = "elasticsearch"
    CASSANDRA = "cassandra"
    COUCHDB = "couchdb"
    DYNAMODB = "dynamodb"
    SQLITE = "sqlite"
    MARIADB = "mariadb"


class DataClassification(Enum):
    """Data sensitivity classifications"""
    PII = "pii"  # Personally Identifiable Information
    PHI = "phi"  # Protected Health Information
    PCI = "pci"  # Payment Card Information
    PASSWORDS = "passwords"
    CREDENTIALS = "credentials"
    API_KEYS = "api_keys"
    CONFIDENTIAL = "confidential"
    INTERNAL = "internal"
    PUBLIC = "public"


class FileShareType(Enum):
    """File share types"""
    SMB = "smb"
    NFS = "nfs"
    FTP = "ftp"
    SFTP = "sftp"
    S3 = "s3"
    AZURE_BLOB = "azure_blob"
    GOOGLE_DRIVE = "google_drive"
    SHAREPOINT = "sharepoint"
    WEBDAV = "webdav"


@dataclass
class Database(Asset):
    """Represents a database"""

    def __init__(
        self,
        id: str,
        name: str,
        db_type: DatabaseType,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.DATABASE,
            name=name,
            **kwargs
        )

        # Initialize database properties
        self.properties.update({
            "name": name,
            "type": db_type.value if isinstance(db_type, DatabaseType) else db_type,
            "version": None,
            "connection_string": None,  # Should be sanitized
            "host": None,
            "port": None,
            "authentication_method": "password",  # password, certificate, windows, etc.
            "encryption_in_transit": False,
            "encryption_at_rest": False,
            "backup_schedule": None,
            "backup_location": None,
            "schemas": [],
            "databases": [],  # List of database names
            "tables_count": 0,
            "size_gb": 0.0,
            "sensitive_data_types": [],
            "users": [],
            "privileges_enumerated": False,
            "excessive_privileges": [],
            "default_credentials": False,
            "publicly_accessible": False,
            "vulnerabilities": [],
        })

    def set_connection(self, host: str, port: int, connection_string: str = None):
        """Set connection details"""
        self.properties["host"] = host
        self.properties["port"] = port
        if connection_string:
            # Sanitize connection string before storing
            self.properties["connection_string"] = self._sanitize_connection_string(connection_string)

    def _sanitize_connection_string(self, conn_str: str) -> str:
        """Sanitize connection string to remove sensitive data"""
        # Simple implementation - should be enhanced
        if "password=" in conn_str.lower():
            parts = conn_str.split(";")
            sanitized = []
            for part in parts:
                if "password=" in part.lower():
                    sanitized.append("Password=<REDACTED>")
                else:
                    sanitized.append(part)
            return ";".join(sanitized)
        return conn_str

    def enable_encryption(self, in_transit: bool = False, at_rest: bool = False):
        """Enable encryption"""
        if in_transit:
            self.properties["encryption_in_transit"] = True
        if at_rest:
            self.properties["encryption_at_rest"] = True

    def add_schema(self, schema_name: str):
        """Add schema"""
        schemas = self.properties.get("schemas", [])
        if schema_name not in schemas:
            schemas.append(schema_name)
            self.properties["schemas"] = schemas

    def add_database(self, db_name: str):
        """Add database name"""
        databases = self.properties.get("databases", [])
        if db_name not in databases:
            databases.append(db_name)
            self.properties["databases"] = databases

    def set_size(self, size_gb: float, tables_count: int):
        """Set database size"""
        self.properties["size_gb"] = size_gb
        self.properties["tables_count"] = tables_count

    def add_sensitive_data_type(self, data_type: DataClassification):
        """Add sensitive data classification"""
        if isinstance(data_type, str):
            data_type = DataClassification(data_type)
        types = self.properties.get("sensitive_data_types", [])
        if data_type.value not in types:
            types.append(data_type.value)
            self.properties["sensitive_data_types"] = types

    def add_user(self, username: str, privileges: List[str] = None):
        """Add database user"""
        user = {
            "username": username,
            "privileges": privileges or []
        }
        self.properties.setdefault("users", []).append(user)

    def flag_excessive_privileges(self, user: str, privileges: List[str]):
        """Flag excessive privileges"""
        excessive = {
            "user": user,
            "privileges": privileges
        }
        self.properties.setdefault("excessive_privileges", []).append(excessive)

    def flag_default_credentials(self):
        """Flag default credentials found"""
        self.properties["default_credentials"] = True

    def set_publicly_accessible(self, accessible: bool = True):
        """Set public accessibility"""
        self.properties["publicly_accessible"] = accessible

    def add_vulnerability(self, cve: str, severity: str, description: str = ""):
        """Add vulnerability"""
        vuln = {
            "cve": cve,
            "severity": severity,
            "description": description
        }
        self.properties.setdefault("vulnerabilities", []).append(vuln)

    def has_sensitive_data(self) -> bool:
        """Check if database contains sensitive data"""
        return len(self.properties.get("sensitive_data_types", [])) > 0


@dataclass
class FileShare(Asset):
    """Represents a file share"""

    def __init__(
        self,
        id: str,
        name: str,
        share_type: FileShareType,
        path: str,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.FILE_SHARE,
            name=name,
            **kwargs
        )

        # Initialize file share properties
        self.properties.update({
            "name": name,
            "type": share_type.value if isinstance(share_type, FileShareType) else share_type,
            "path": path,
            "host": None,
            "permissions": {},  # user/group -> permission mapping
            "size_gb": 0.0,
            "file_count": 0,
            "sensitive_files_found": [],
            "world_readable": False,
            "world_writable": False,
            "anonymous_access": False,
            "encryption_enabled": False,
            "interesting_files": [],
            "file_extensions": {},  # extension -> count mapping
            "shares_enumerated": False,
        })

    def set_host(self, host: str):
        """Set host"""
        self.properties["host"] = host

    def add_permission(self, principal: str, permission: str):
        """Add permission"""
        permissions = self.properties.get("permissions", {})
        if principal not in permissions:
            permissions[principal] = []
        if permission not in permissions[principal]:
            permissions[principal].append(permission)
        self.properties["permissions"] = permissions

    def set_size(self, size_gb: float, file_count: int):
        """Set share size"""
        self.properties["size_gb"] = size_gb
        self.properties["file_count"] = file_count

    def add_sensitive_file(self, file_path: str, classification: DataClassification = None):
        """Add sensitive file"""
        file_info = {"path": file_path}
        if classification:
            if isinstance(classification, DataClassification):
                classification = classification.value
            file_info["classification"] = classification

        self.properties.setdefault("sensitive_files_found", []).append(file_info)

    def set_world_accessible(self, readable: bool = False, writable: bool = False):
        """Set world accessibility"""
        if readable:
            self.properties["world_readable"] = True
        if writable:
            self.properties["world_writable"] = True

    def enable_anonymous_access(self):
        """Enable anonymous access (security issue)"""
        self.properties["anonymous_access"] = True

    def enable_encryption(self):
        """Enable encryption"""
        self.properties["encryption_enabled"] = True

    def add_interesting_file(self, file_path: str, reason: str):
        """Add interesting file"""
        file_info = {
            "path": file_path,
            "reason": reason
        }
        self.properties.setdefault("interesting_files", []).append(file_info)

    def track_file_extension(self, extension: str):
        """Track file extension count"""
        extensions = self.properties.get("file_extensions", {})
        extensions[extension] = extensions.get(extension, 0) + 1
        self.properties["file_extensions"] = extensions

    def is_publicly_accessible(self) -> bool:
        """Check if share is publicly accessible"""
        return self.properties.get("world_readable", False) or \
               self.properties.get("anonymous_access", False)

    def has_sensitive_files(self) -> bool:
        """Check if share contains sensitive files"""
        return len(self.properties.get("sensitive_files_found", [])) > 0
