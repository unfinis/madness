"""Cloud resource asset models"""

from dataclasses import dataclass
from enum import Enum
from typing import List, Optional

from pentest_asset_model.models.base import (
    Asset,
    AssetType,
    RelationshipType,
)


class CloudProvider(Enum):
    """Cloud service providers"""
    AWS = "aws"
    AZURE = "azure"
    GCP = "gcp"
    DIGITALOCEAN = "digitalocean"
    ALIBABA = "alibaba"
    IBM = "ibm"
    ORACLE = "oracle"


class BucketACL(Enum):
    """Storage bucket ACLs"""
    PRIVATE = "private"
    PUBLIC_READ = "public_read"
    PUBLIC_WRITE = "public_write"
    PUBLIC_READ_WRITE = "public_read_write"
    AUTHENTICATED_READ = "authenticated_read"


@dataclass
class CloudAccount(Asset):
    """Represents a cloud account"""

    def __init__(
        self,
        id: str,
        account_id: str,
        provider: CloudProvider,
        account_name: str = None,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.CLOUD_ACCOUNT,
            name=account_name or account_id,
            **kwargs
        )

        # Initialize cloud account properties
        self.properties.update({
            "provider": provider.value if isinstance(provider, CloudProvider) else provider,
            "account_id": account_id,
            "account_name": account_name,
            "regions_active": [],
            "iam_users_count": 0,
            "iam_roles_count": 0,
            "mfa_enforced": False,
            "root_access_keys": False,
            "publicly_exposed_resources": [],
            "security_groups": [],
            "vpcs": [],
            "instances": [],
            "storage_buckets": [],
            "databases": [],
            "api_keys_found": [],
            "misconfigurations": [],
        })

    def add_region(self, region: str):
        """Add active region"""
        regions = self.properties.get("regions_active", [])
        if region not in regions:
            regions.append(region)
            self.properties["regions_active"] = regions

    def set_iam_counts(self, users: int, roles: int):
        """Set IAM user and role counts"""
        self.properties["iam_users_count"] = users
        self.properties["iam_roles_count"] = roles

    def enable_mfa(self):
        """Mark MFA as enforced"""
        self.properties["mfa_enforced"] = True

    def flag_root_keys(self):
        """Flag root access keys present"""
        self.properties["root_access_keys"] = True

    def add_exposed_resource(self, resource_id: str, resource_type: str):
        """Add publicly exposed resource"""
        resource = {
            "id": resource_id,
            "type": resource_type
        }
        self.properties.setdefault("publicly_exposed_resources", []).append(resource)

    def add_instance(self, instance_id: str):
        """Add cloud instance"""
        self.add_relationship(RelationshipType.CONTAINS, instance_id)
        if instance_id not in self.properties.get("instances", []):
            self.properties.setdefault("instances", []).append(instance_id)

    def add_bucket(self, bucket_id: str):
        """Add storage bucket"""
        self.add_relationship(RelationshipType.CONTAINS, bucket_id)
        if bucket_id not in self.properties.get("storage_buckets", []):
            self.properties.setdefault("storage_buckets", []).append(bucket_id)

    def add_misconfiguration(self, issue: str, severity: str, resource: str = None):
        """Add security misconfiguration"""
        misconfig = {
            "issue": issue,
            "severity": severity,
            "resource": resource
        }
        self.properties.setdefault("misconfigurations", []).append(misconfig)


@dataclass
class CloudInstance(Asset):
    """Represents a cloud compute instance"""

    def __init__(
        self,
        id: str,
        instance_id: str,
        provider: CloudProvider,
        instance_type: str,
        region: str,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.CLOUD_INSTANCE,
            name=instance_id,
            **kwargs
        )

        # Initialize cloud instance properties
        self.properties.update({
            "provider": provider.value if isinstance(provider, CloudProvider) else provider,
            "instance_id": instance_id,
            "type": instance_type,
            "region": region,
            "vpc_id": None,
            "subnet_id": None,
            "availability_zone": None,
            "public_ip": None,
            "private_ip": None,
            "security_groups": [],
            "iam_role": None,
            "user_data_script": False,
            "metadata_accessible": False,
            "tags": {},
            "state": "running",  # running, stopped, terminated
            "os_type": None,
            "vulnerabilities": [],
        })

    def set_network(self, vpc_id: str, subnet_id: str, az: str = None):
        """Set network configuration"""
        self.properties["vpc_id"] = vpc_id
        self.properties["subnet_id"] = subnet_id
        if az:
            self.properties["availability_zone"] = az

    def set_ips(self, public_ip: str = None, private_ip: str = None):
        """Set IP addresses"""
        if public_ip:
            self.properties["public_ip"] = public_ip
        if private_ip:
            self.properties["private_ip"] = private_ip

    def add_security_group(self, sg_id: str, sg_name: str = None):
        """Add security group"""
        sg = {"id": sg_id}
        if sg_name:
            sg["name"] = sg_name
        self.properties.setdefault("security_groups", []).append(sg)

    def set_iam_role(self, role: str):
        """Set IAM role"""
        self.properties["iam_role"] = role

    def has_user_data(self):
        """Mark that user data script is present"""
        self.properties["user_data_script"] = True

    def enable_metadata_access(self):
        """Mark metadata as accessible"""
        self.properties["metadata_accessible"] = True

    def add_tag(self, key: str, value: str):
        """Add instance tag"""
        tags = self.properties.get("tags", {})
        tags[key] = value
        self.properties["tags"] = tags

    def is_publicly_accessible(self) -> bool:
        """Check if instance is publicly accessible"""
        return self.properties.get("public_ip") is not None


@dataclass
class StorageBucket(Asset):
    """Represents a cloud storage bucket"""

    def __init__(
        self,
        id: str,
        name: str,
        provider: CloudProvider,
        region: str,
        **kwargs
    ):
        super().__init__(
            id=id,
            asset_type=AssetType.STORAGE_BUCKET,
            name=name,
            **kwargs
        )

        # Initialize storage bucket properties
        self.properties.update({
            "provider": provider.value if isinstance(provider, CloudProvider) else provider,
            "name": name,
            "region": region,
            "acl": BucketACL.PRIVATE.value,
            "versioning": False,
            "encryption": False,
            "encryption_type": None,
            "lifecycle_policies": [],
            "cors_enabled": False,
            "website_hosting": False,
            "public_access_block": True,
            "logging_enabled": False,
            "size_bytes": 0,
            "object_count": 0,
            "sensitive_data_found": False,
            "sensitive_files": [],
            "permissions": [],
        })

    def set_acl(self, acl: BucketACL):
        """Set bucket ACL"""
        if isinstance(acl, str):
            acl = BucketACL(acl)
        self.properties["acl"] = acl.value

    def enable_versioning(self):
        """Enable versioning"""
        self.properties["versioning"] = True

    def enable_encryption(self, encryption_type: str = "AES256"):
        """Enable encryption"""
        self.properties["encryption"] = True
        self.properties["encryption_type"] = encryption_type

    def add_lifecycle_policy(self, policy: str):
        """Add lifecycle policy"""
        policies = self.properties.get("lifecycle_policies", [])
        if policy not in policies:
            policies.append(policy)
            self.properties["lifecycle_policies"] = policies

    def enable_cors(self):
        """Enable CORS"""
        self.properties["cors_enabled"] = True

    def enable_website_hosting(self):
        """Enable website hosting"""
        self.properties["website_hosting"] = True

    def disable_public_access_block(self):
        """Disable public access block (security issue)"""
        self.properties["public_access_block"] = False

    def set_size(self, size_bytes: int, object_count: int):
        """Set bucket size"""
        self.properties["size_bytes"] = size_bytes
        self.properties["object_count"] = object_count

    def flag_sensitive_data(self, files: List[str] = None):
        """Flag sensitive data found"""
        self.properties["sensitive_data_found"] = True
        if files:
            self.properties["sensitive_files"] = files

    def add_permission(self, principal: str, permission: str):
        """Add bucket permission"""
        perm = {
            "principal": principal,
            "permission": permission
        }
        self.properties.setdefault("permissions", []).append(perm)

    def is_public(self) -> bool:
        """Check if bucket is publicly accessible"""
        acl = self.properties.get("acl")
        return acl in [
            BucketACL.PUBLIC_READ.value,
            BucketACL.PUBLIC_WRITE.value,
            BucketACL.PUBLIC_READ_WRITE.value
        ] or not self.properties.get("public_access_block", True)
