"""
Corporate Network Penetration Test Scenario

This example demonstrates a realistic pentest scenario:
1. External reconnaissance discovers network
2. Initial access via vulnerable service
3. Network enumeration reveals internal assets
4. Credential harvesting
5. Lateral movement
6. Domain compromise
7. Trigger-based methodology orchestration
"""

from pentest_asset_model import AssetRepository
from pentest_asset_model.models import (
    NetworkSegment, Host, Service, User, Credential, DomainController,
    Database, FileShare, Application,
    SecurityZone, OSType, PrivilegeLevel, CredentialType,
    ServiceState, DatabaseType, FileShareType
)
from pentest_asset_model.services import QueryEngine, TriggerEngine
from pentest_asset_model.utils import RiskScorer
from pentest_asset_model.models.base import LifecycleState, DiscoveryMethod


def run_corporate_network_scenario():
    """Execute complete corporate network pentest scenario"""

    print("=" * 80)
    print("CORPORATE NETWORK PENETRATION TEST SCENARIO")
    print("=" * 80)
    print()

    # Initialize repository
    repo = AssetRepository()
    query = QueryEngine(repo)
    triggers = TriggerEngine(repo)

    # Register common triggers
    triggers.create_example_triggers()

    # =========================================================================
    # PHASE 1: EXTERNAL RECONNAISSANCE
    # =========================================================================
    print("PHASE 1: External Reconnaissance")
    print("-" * 80)

    # Discover external network segment
    dmz_network = NetworkSegment(
        id="net_dmz_1",
        name="DMZ Network",
        cidr="203.0.113.0/24",
        security_zone=SecurityZone.DMZ,
        discovery_method=DiscoveryMethod.NETWORK_SCAN
    )
    dmz_network.update_property("gateway_ips", ["203.0.113.1"])
    dmz_network.set_access_level("full")
    repo.add_asset(dmz_network)

    # Discover web server
    web_server = Host(
        id="host_web1",
        hostname="www.acmecorp.com",
        ip="203.0.113.10",
        os_type=OSType.LINUX,
        discovery_method=DiscoveryMethod.PORT_SCAN
    )
    web_server.update_property("os_version", "Ubuntu 20.04")
    web_server.set_system_role("server")
    web_server.add_open_port(80, "tcp", "http")
    web_server.add_open_port(443, "tcp", "https")
    web_server.add_open_port(22, "tcp", "ssh")
    repo.add_asset(web_server)

    # Add to network
    dmz_network.add_host(web_server.id)

    # Discover web service
    http_service = Service(
        id="svc_http_1",
        name="Apache HTTP Server",
        port=80,
        host_id=web_server.id
    )
    http_service.set_version("2.4.41", "Apache/2.4.41 (Ubuntu)")
    http_service.add_vulnerability("CVE-2021-41773", "critical", "Path traversal")
    http_service.transition_state(LifecycleState.VALIDATED, "Service banner retrieved")
    repo.add_asset(http_service)

    dmz_network.add_web_service("203.0.113.10", 80, "apache", version="2.4.41")

    print(f"✓ Discovered DMZ network: {dmz_network.name}")
    print(f"✓ Discovered host: {web_server.name} ({web_server.get_property('ip_addresses')[0]})")
    print(f"✓ Discovered service: {http_service.name} (port {http_service.properties['port']})")
    print(f"✓ Found vulnerability: CVE-2021-41773 (Critical)")
    print()

    # =========================================================================
    # PHASE 2: INITIAL ACCESS
    # =========================================================================
    print("PHASE 2: Initial Access via Service Exploitation")
    print("-" * 80)

    # Exploit vulnerable service
    http_service.mark_exploited()
    http_service.transition_state(LifecycleState.EXPLOITED, "CVE-2021-41773 exploited")
    web_server.transition_state(LifecycleState.EXPLOITED, "Shell obtained via Apache vulnerability")

    # Obtain credentials
    www_data_cred = Credential(
        id="cred_www_data",
        username="www-data",
        credential_type=CredentialType.PASSWORD,
        value="www-data",
        discovery_method=DiscoveryMethod.VULNERABILITY_SCAN
    )
    www_data_cred.set_validity("valid")
    www_data_cred.add_scope(web_server.id)
    www_data_cred.set_discovered_from("Apache vulnerability exploitation")
    repo.add_asset(www_data_cred)

    print(f"✓ Exploited: {http_service.name}")
    print(f"✓ Obtained shell on: {web_server.name}")
    print(f"✓ Acquired credentials: {www_data_cred.properties['username']}")
    print()

    # =========================================================================
    # PHASE 3: NETWORK ENUMERATION
    # =========================================================================
    print("PHASE 3: Internal Network Discovery")
    print("-" * 80)

    # Discover internal network
    internal_network = NetworkSegment(
        id="net_internal_1",
        name="Corporate Internal Network",
        cidr="192.168.1.0/24",
        security_zone=SecurityZone.INTERNAL,
        discovery_method=DiscoveryMethod.DERIVED
    )
    internal_network.update_property("domain_name", "acmecorp.local")
    internal_network.update_property("dns_servers", ["192.168.1.10"])
    internal_network.set_access_level("partial")
    repo.add_asset(internal_network)

    # Discover domain controller
    dc = DomainController(
        id="host_dc1",
        hostname="DC01",
        ip="192.168.1.10",
        domain_name="acmecorp.local",
        discovery_method=DiscoveryMethod.DNS_ENUMERATION
    )
    dc.update_property("os_version", "Windows Server 2019")
    dc.set_domain_stats(users=250, computers=180, gpos=15)
    dc.add_fsmo_role("PDC Emulator")
    dc.add_fsmo_role("RID Master")
    dc.add_open_port(389, "tcp", "ldap")
    dc.add_open_port(88, "tcp", "kerberos")
    dc.add_open_port(445, "tcp", "smb")
    repo.add_asset(dc)

    internal_network.add_host(dc.id)
    internal_network.update_property("domain_controllers", [dc.id])

    # Discover file server
    file_server = Host(
        id="host_fs1",
        hostname="FS01",
        ip="192.168.1.50",
        os_type=OSType.WINDOWS
    )
    file_server.update_property("os_version", "Windows Server 2016")
    file_server.set_domain_member("acmecorp.local")
    file_server.add_open_port(445, "tcp", "smb")
    repo.add_asset(file_server)

    internal_network.add_host(file_server.id)
    internal_network.update_property("smb_hosts", [file_server.id])

    # Discover database server
    db_server = Host(
        id="host_db1",
        hostname="SQLSERVER01",
        ip="192.168.1.100",
        os_type=OSType.WINDOWS
    )
    db_server.update_property("os_version", "Windows Server 2019")
    db_server.set_domain_member("acmecorp.local")
    db_server.add_open_port(1433, "tcp", "mssql")
    repo.add_asset(db_server)

    internal_network.add_host(db_server.id)

    print(f"✓ Discovered internal network: {internal_network.name}")
    print(f"✓ Discovered domain controller: {dc.name} ({dc.get_property('domain_name')})")
    print(f"✓ Discovered file server: {file_server.name}")
    print(f"✓ Discovered database server: {db_server.name}")
    print(f"  - Domain users: {dc.properties['user_count']}")
    print(f"  - Domain computers: {dc.properties['computer_count']}")
    print()

    # =========================================================================
    # PHASE 4: CREDENTIAL HARVESTING
    # =========================================================================
    print("PHASE 4: Credential Harvesting")
    print("-" * 80)

    # Harvest domain credentials
    user_cred = Credential(
        id="cred_jsmith",
        username="acmecorp\\jsmith",
        credential_type=CredentialType.PASSWORD,
        value="Password123!",
        discovery_method=DiscoveryMethod.CREDENTIAL_SPRAY
    )
    user_cred.set_validity("valid")
    user_cred.set_privilege_level(PrivilegeLevel.USER)
    user_cred.add_scope(dc.id)
    user_cred.add_scope(file_server.id)
    user_cred.set_discovered_from("LLMNR poisoning")
    repo.add_asset(user_cred)

    # Add to network
    internal_network.add_credential("acmecorp\\jsmith", password="Password123!", source="llmnr_poisoning")

    # Harvest NTLM hash
    admin_hash = Credential(
        id="cred_admin_hash",
        username="acmecorp\\administrator",
        credential_type=CredentialType.HASH,
        value="aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c",
        discovery_method=DiscoveryMethod.DERIVED
    )
    admin_hash.set_hash_type("ntlm")
    admin_hash.set_privilege_level(PrivilegeLevel.DOMAIN_ADMIN)
    admin_hash.set_validity("unknown")
    admin_hash.set_discovered_from("SAM dump")
    repo.add_asset(admin_hash)

    print(f"✓ Harvested credential: {user_cred.properties['username']}")
    print(f"✓ Harvested NTLM hash: {admin_hash.properties['username']}")
    print()

    # =========================================================================
    # PHASE 5: LATERAL MOVEMENT
    # =========================================================================
    print("PHASE 5: Lateral Movement")
    print("-" * 80)

    # Access file share
    file_share = FileShare(
        id="share_finance",
        name="Finance Share",
        share_type=FileShareType.SMB,
        path="\\\\FS01\\Finance"
    )
    file_share.set_host(file_server.id)
    file_share.add_permission("Domain Users", "read")
    file_share.add_sensitive_file("\\\\FS01\\Finance\\passwords.xlsx", "passwords")
    file_share.add_sensitive_file("\\\\FS01\\Finance\\salaries.xlsx", "pii")
    file_share.set_size(50.5, 1250)
    file_share.transition_state(LifecycleState.ENUMERATED, "Share accessed with user credentials")
    repo.add_asset(file_share)

    # Access database
    database = Database(
        id="db_customers",
        name="CustomerDB",
        db_type=DatabaseType.MSSQL
    )
    database.set_connection(db_server.get_property("ip_addresses")[0], 1433)
    database.add_database("Customers")
    database.add_database("Orders")
    database.add_sensitive_data_type("pii")
    database.add_sensitive_data_type("pci")
    database.set_size(250.0, 150)
    database.transition_state(LifecycleState.ENUMERATED, "Database enumerated")
    repo.add_asset(database)

    print(f"✓ Accessed file share: {file_share.name}")
    print(f"  - Found {len(file_share.properties['sensitive_files_found'])} sensitive files")
    print(f"✓ Accessed database: {database.name}")
    print(f"  - Contains PII and PCI data")
    print()

    # =========================================================================
    # PHASE 6: PRIVILEGE ESCALATION
    # =========================================================================
    print("PHASE 6: Privilege Escalation")
    print("-" * 80)

    # Crack admin hash
    admin_hash.mark_cracked("Admin123!")
    admin_hash.test_against(dc.id, success=True)
    admin_hash.add_scope(dc.id)

    # Mark DC as compromised
    dc.transition_state(LifecycleState.EXPLOITED, "Domain Admin credentials obtained")

    print(f"✓ Cracked NTLM hash: {admin_hash.properties['cleartext_password']}")
    print(f"✓ Verified credentials on: {dc.name}")
    print(f"✓ Domain compromised!")
    print()

    # =========================================================================
    # PHASE 7: TRIGGER DETECTION
    # =========================================================================
    print("PHASE 7: Trigger-Based Methodology Detection")
    print("-" * 80)

    detected_triggers = triggers.detect_all_triggers()
    print(f"✓ Detected {len(detected_triggers)} methodology triggers")

    for trigger, asset in detected_triggers[:5]:  # Show first 5
        dedup_key = trigger.generate_deduplication_key(asset)
        print(f"  - {trigger.methodology_name} for {asset.name}")
        print(f"    Deduplication key: {dedup_key}")

    # Group batchable triggers
    batch_groups = triggers.group_batch_triggers(detected_triggers)
    print(f"\n✓ Grouped into {len(batch_groups)} batch operations")
    print()

    # =========================================================================
    # PHASE 8: RISK ASSESSMENT
    # =========================================================================
    print("PHASE 8: Risk Assessment")
    print("-" * 80)

    # Calculate risk scores
    risk_profile = RiskScorer.calculate_repository_risk_profile(repo)

    print(f"Repository Risk Profile:")
    print(f"  - Total Assets: {repo.count_assets()}")
    print(f"  - Average Risk: {risk_profile['average_risk']:.2f}/10")
    print(f"  - Maximum Risk: {risk_profile['max_risk']:.2f}/10")
    print(f"  - High Risk Assets: {risk_profile['high_risk_count']}")
    print(f"  - Medium Risk Assets: {risk_profile['medium_risk_count']}")
    print(f"  - Low Risk Assets: {risk_profile['low_risk_count']}")
    print()

    # Show high-risk assets
    high_risk_assets = [a for a in repo.get_all_assets() if a.risk_score >= 7.0]
    print(f"High-Risk Assets:")
    for asset in sorted(high_risk_assets, key=lambda a: a.risk_score, reverse=True):
        print(f"  - {asset.name} ({asset.asset_type.value}): {asset.risk_score:.2f}/10")
    print()

    # =========================================================================
    # PHASE 9: QUERY EXAMPLES
    # =========================================================================
    print("PHASE 9: Advanced Queries")
    print("-" * 80)

    # Find compromised assets
    compromised = query.find_compromised_assets()
    print(f"✓ Compromised assets: {len(compromised)}")
    for asset in compromised:
        print(f"  - {asset.name} ({asset.lifecycle_state.value})")

    # Find valid credentials
    valid_creds = query.find_valid_credentials()
    print(f"\n✓ Valid credentials: {len(valid_creds)}")
    for cred in valid_creds:
        print(f"  - {cred.properties['username']} (privilege: {cred.properties['privilege_level']})")

    # Find sensitive data stores
    sensitive_stores = query.find_sensitive_data_stores()
    print(f"\n✓ Sensitive data stores: {len(sensitive_stores)}")
    for store in sensitive_stores:
        print(f"  - {store.name} ({store.asset_type.value})")

    print()

    # =========================================================================
    # SUMMARY
    # =========================================================================
    print("=" * 80)
    print("ENGAGEMENT SUMMARY")
    print("=" * 80)
    print(f"Total Assets Discovered: {repo.count_assets()}")
    print(f"Networks: {len(repo.get_assets_by_type('network_segment'))}")
    print(f"Hosts: {len(repo.get_assets_by_type('host'))}")
    print(f"Services: {len(repo.get_assets_by_type('service'))}")
    print(f"Credentials: {len(repo.get_assets_by_type('credential'))}")
    print(f"Databases: {len(repo.get_assets_by_type('database'))}")
    print(f"File Shares: {len(repo.get_assets_by_type('file_share'))}")
    print()
    print(f"Lifecycle States:")
    for state, count in repo.count_by_state().items():
        print(f"  - {state}: {count}")
    print()
    print(f"Average Risk Score: {risk_profile['average_risk']:.2f}/10")
    print(f"Compromised Assets: {len(compromised)}")
    print(f"Valid Credentials: {len(valid_creds)}")
    print(f"Pending Methodology Triggers: {len(detected_triggers)}")
    print()

    return repo, query, triggers


if __name__ == "__main__":
    repo, query, triggers = run_corporate_network_scenario()

    print("✓ Scenario complete!")
    print("\nYou can now interact with the repository:")
    print("  - repo: AssetRepository instance")
    print("  - query: QueryEngine instance")
    print("  - triggers: TriggerEngine instance")
