# Service Identification Atomic Steps
# Phase: SERVICE_IDENTIFICATION (Priority: 6-7)
# Trigger: Open port discovered without service identification

steps:
  - id: service_identification_banner_grab
    name: "Service Banner Grabbing"
    description: "Grab banner from open port to identify service"
    phase: service_identification
    priority: 7

    trigger_conditions:
      - type: asset_created
        asset_type: service
        description: "New service discovered"
      - type: property_match
        asset_type: service
        property_name: state
        property_pattern: "open"
      - type: property_null
        asset_type: service
        property_name: service_type
        description: "Service type not yet identified"

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sV -p {port} -oX {output_dir}/nmap_banner_{host_safe}_{port}.xml {host}"
        preferred: true
        timeout: 60
        requires_elevation: false
        notes: "Nmap service version detection"

      - tool: nc
        platforms: [linux, macos]
        command: "echo '' | nc -vn -w 3 {host} {port} 2>&1 | tee {output_dir}/banner_{host_safe}_{port}.txt"
        preferred: false
        timeout: 10
        requires_elevation: false
        notes: "Raw netcat banner grab"

      - tool: amap
        platforms: [linux]
        command: "amap -bq {host} {port} > {output_dir}/amap_{host_safe}_{port}.txt"
        preferred: false
        timeout: 30
        requires_elevation: false
        notes: "Application mapper for service identification"

    output_parser:
      type: nmap_xml
      updates_asset:
        properties:
          service_type: "{port.service.name}"
          service_product: "{port.service.product}"
          service_version: "{port.service.version}"
          banner: "{port.service.extrainfo}"

    deduplication_signature_fields: [host, port]
    batch_compatible: true
    max_batch_size: 100
    cooldown_seconds: 3600
    next_step_ids: [service_identification_nse_scripts]

    metadata:
      mitre_attack: T1046
      references:
        - https://nmap.org/book/vscan.html
      notes: |
        Banner grabbing is the first step in service identification.
        Reveals service type, version, and sometimes OS information.
        Essential for vulnerability assessment and exploit selection.

  - id: service_identification_nse_scripts
    name: "Nmap NSE Service Discovery"
    description: "Run Nmap NSE scripts for comprehensive service identification"
    phase: service_identification
    priority: 6

    trigger_conditions:
      - type: property_not_null
        asset_type: service
        property_name: service_type
        description: "Service type identified"
      - type: property_null
        asset_type: service
        property_name: nse_scripts_run
        description: "NSE scripts not yet executed"

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sV -p {port} --script=banner,default,discovery,safe -oX {output_dir}/nmap_nse_{host_safe}_{port}.xml {host}"
        preferred: true
        timeout: 300
        requires_elevation: false
        notes: "Run safe NSE scripts for service discovery"

      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -p {port} --script={service_type}-* -oX {output_dir}/nmap_service_specific_{host_safe}_{port}.xml {host}"
        preferred: false
        timeout: 300
        requires_elevation: false
        notes: "Run service-specific NSE scripts (e.g., ssh-*, http-*, smb-*)"

    output_parser:
      type: nmap_xml
      updates_asset:
        properties:
          nse_scripts_run: true
          nse_findings: "{script_results}"
          additional_info: "{script_output}"

    deduplication_signature_fields: [host, port, service_type]
    batch_compatible: true
    max_batch_size: 50
    cooldown_seconds: 3600
    next_step_ids: []

    metadata:
      mitre_attack: T1046
      notes: |
        NSE scripts provide deep service fingerprinting.
        Can detect specific versions, configurations, vulnerabilities.
        Safe scripts category avoids intrusive tests.

  - id: service_identification_ssl_tls_scan
    name: "SSL/TLS Service Scanning"
    description: "Identify and analyze SSL/TLS encrypted services"
    phase: service_identification
    priority: 7

    trigger_conditions:
      - type: property_match
        asset_type: service
        property_name: port
        property_pattern: "(443|8443|636|3389|989|990|992|993|994|995)"
        description: "Common SSL/TLS ports"
      - type: property_null
        asset_type: service
        property_name: ssl_analyzed

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -p {port} --script ssl-cert,ssl-enum-ciphers -oX {output_dir}/nmap_ssl_{host_safe}_{port}.xml {host}"
        preferred: true
        timeout: 120
        requires_elevation: false
        notes: "SSL certificate and cipher enumeration"

      - tool: sslscan
        platforms: [linux, macos]
        command: "sslscan --xml={output_dir}/sslscan_{host_safe}_{port}.xml {host}:{port}"
        preferred: false
        timeout: 60
        requires_elevation: false
        notes: "Comprehensive SSL/TLS scanner"

      - tool: testssl
        platforms: [linux, macos]
        command: "testssl.sh --jsonfile {output_dir}/testssl_{host_safe}_{port}.json {host}:{port}"
        preferred: false
        timeout: 300
        requires_elevation: false
        notes: "Detailed SSL/TLS testing including vulnerabilities"

    output_parser:
      type: nmap_xml
      updates_asset:
        properties:
          ssl_analyzed: true
          ssl_version: "{ssl.version}"
          ssl_cipher_suites: "{ssl.ciphers}"
          ssl_cert_subject: "{ssl.cert.subject}"
          ssl_cert_issuer: "{ssl.cert.issuer}"
          ssl_cert_expiry: "{ssl.cert.not_after}"
          ssl_vulnerabilities: "{ssl.vulnerabilities}"

    deduplication_signature_fields: [host, port]
    batch_compatible: true
    max_batch_size: 50
    cooldown_seconds: 3600
    next_step_ids: [ssl_vulnerability_checks]

    metadata:
      mitre_attack: T1046
      cvss_related: true
      references:
        - https://testssl.sh/
        - https://github.com/rbsec/sslscan
      notes: |
        SSL/TLS analysis reveals:
        - Weak ciphers and protocols (SSLv3, TLS 1.0)
        - Certificate validation issues
        - Known vulnerabilities (POODLE, BEAST, Heartbleed)
        - Certificate details for OSINT

  - id: service_identification_http_fingerprint
    name: "HTTP Service Fingerprinting"
    description: "Identify HTTP server type, version, and technologies"
    phase: service_identification
    priority: 7

    trigger_conditions:
      - type: property_match
        asset_type: service
        property_name: service_type
        property_pattern: "(http|https|http-proxy|http-alt)"
        description: "HTTP-based service"
      - type: property_null
        asset_type: service
        property_name: http_fingerprinted

    commands:
      - tool: whatweb
        platforms: [linux, macos]
        command: "whatweb --color=never --log-xml={output_dir}/whatweb_{host_safe}_{port}.xml http://{host}:{port}/"
        preferred: true
        timeout: 60
        requires_elevation: false
        notes: "Web technology fingerprinting"

      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -p {port} --script http-headers,http-methods,http-title,http-server-header -oX {output_dir}/nmap_http_{host_safe}_{port}.xml {host}"
        preferred: false
        timeout: 120
        requires_elevation: false
        notes: "HTTP enumeration with NSE scripts"

      - tool: curl
        platforms: [linux, macos, windows]
        command: "curl -I -L -s http://{host}:{port}/ > {output_dir}/http_headers_{host_safe}_{port}.txt"
        preferred: false
        timeout: 30
        requires_elevation: false
        notes: "Simple HTTP header grab"

    output_parser:
      type: custom
      updates_asset:
        properties:
          http_fingerprinted: true
          http_server: "{headers.Server}"
          http_title: "{page.title}"
          http_technologies: "{detected_technologies}"
          http_framework: "{detected_framework}"
          http_cms: "{detected_cms}"

    deduplication_signature_fields: [host, port]
    batch_compatible: true
    max_batch_size: 100
    cooldown_seconds: 3600
    next_step_ids: [web_service_enumeration]

    metadata:
      mitre_attack: T1046
      references:
        - https://github.com/urbanadventurer/WhatWeb
      notes: |
        HTTP fingerprinting identifies:
        - Web server (Apache, Nginx, IIS)
        - Application framework (Django, Rails, Laravel)
        - CMS (WordPress, Drupal, Joomla)
        - JavaScript libraries and frameworks
        - WAF/CDN presence

  - id: service_identification_smb_enumeration
    name: "SMB Service Identification"
    description: "Enumerate SMB service version and capabilities"
    phase: service_identification
    priority: 7

    trigger_conditions:
      - type: property_match
        asset_type: service
        property_name: port
        property_pattern: "(139|445)"
      - type: property_match
        asset_type: service
        property_name: protocol
        property_pattern: "tcp"
      - type: property_null
        asset_type: service
        property_name: smb_version

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -p {port} --script smb-protocols,smb-security-mode,smb-os-discovery -oX {output_dir}/nmap_smb_{host_safe}.xml {host}"
        preferred: true
        timeout: 120
        requires_elevation: false
        notes: "SMB protocol and OS discovery"

      - tool: smbclient
        platforms: [linux, macos]
        command: "smbclient -L //{host}/ -N 2>&1 | tee {output_dir}/smbclient_{host_safe}.txt"
        preferred: false
        timeout: 30
        requires_elevation: false
        notes: "List SMB shares without authentication"

      - tool: enum4linux
        platforms: [linux, macos]
        command: "enum4linux -a {host} > {output_dir}/enum4linux_{host_safe}.txt"
        preferred: false
        timeout: 300
        requires_elevation: false
        notes: "Comprehensive SMB enumeration"

    output_parser:
      type: nmap_xml
      updates_asset:
        properties:
          service_type: "smb"
          smb_version: "{smb.dialects}"
          smb_signing: "{smb.signing}"
          os_type: "{smb.os}"
          computer_name: "{smb.computer_name}"
          domain_name: "{smb.domain}"

    deduplication_signature_fields: [host, port]
    batch_compatible: true
    max_batch_size: 50
    cooldown_seconds: 3600
    next_step_ids: [smb_enumeration]

    metadata:
      mitre_attack: T1046
      references:
        - https://nmap.org/nsedoc/scripts/smb-protocols.html
      notes: |
        SMB identification reveals:
        - SMB protocol versions (SMBv1, SMBv2, SMBv3)
        - Message signing configuration
        - OS and domain information
        - Anonymous access availability

  - id: service_identification_database_fingerprint
    name: "Database Service Fingerprinting"
    description: "Identify database type and version"
    phase: service_identification
    priority: 7

    trigger_conditions:
      - type: property_match
        asset_type: service
        property_name: port
        property_pattern: "(1433|3306|5432|1521|27017|6379|9200|9042)"
        description: "Common database ports"
      - type: property_null
        asset_type: service
        property_name: database_type

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -p {port} -sV --script=banner -oX {output_dir}/nmap_db_{host_safe}_{port}.xml {host}"
        preferred: true
        timeout: 60
        requires_elevation: false
        notes: "Database service version detection"

    output_parser:
      type: nmap_xml
      updates_asset:
        properties:
          service_type: "{port.service.name}"
          database_type: "{port.service.product}"
          database_version: "{port.service.version}"

    deduplication_signature_fields: [host, port]
    batch_compatible: true
    max_batch_size: 100
    cooldown_seconds: 3600
    next_step_ids: []

    metadata:
      mitre_attack: T1046
      notes: |
        Database identification for common systems:
        - MySQL/MariaDB: 3306
        - PostgreSQL: 5432
        - MSSQL: 1433
        - Oracle: 1521
        - MongoDB: 27017
        - Redis: 6379
        - Elasticsearch: 9200
        - Cassandra: 9042

  - id: service_identification_ssh_algorithms
    name: "SSH Algorithm Enumeration"
    description: "Enumerate supported SSH algorithms and configuration"
    phase: service_identification
    priority: 7

    trigger_conditions:
      - type: property_match
        asset_type: service
        property_name: port
        property_pattern: "22"
      - type: property_match
        asset_type: service
        property_name: service_type
        property_pattern: "ssh"
      - type: property_null
        asset_type: service
        property_name: ssh_algorithms_enum

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -p {port} --script ssh2-enum-algos,ssh-hostkey -oX {output_dir}/nmap_ssh_algos_{host_safe}.xml {host}"
        preferred: true
        timeout: 60
        requires_elevation: false
        notes: "Enumerate SSH algorithms and host keys"

      - tool: ssh-audit
        platforms: [linux, macos]
        command: "ssh-audit {host}:{port} > {output_dir}/ssh_audit_{host_safe}.txt"
        preferred: false
        timeout: 30
        requires_elevation: false
        notes: "Comprehensive SSH security audit"

    output_parser:
      type: nmap_xml
      updates_asset:
        properties:
          ssh_algorithms_enum: true
          ssh_kex_algorithms: "{ssh.kex_algorithms}"
          ssh_encryption_algorithms: "{ssh.encryption}"
          ssh_mac_algorithms: "{ssh.mac}"
          ssh_host_key_algorithms: "{ssh.host_key_algorithms}"
          ssh_compression: "{ssh.compression}"

    deduplication_signature_fields: [host, port]
    batch_compatible: true
    max_batch_size: 100
    cooldown_seconds: 3600
    next_step_ids: [ssh_enumeration]

    metadata:
      mitre_attack: T1046
      references:
        - https://github.com/jtesta/ssh-audit
      notes: |
        SSH algorithm enumeration reveals:
        - Weak algorithms (DES, MD5, SHA1)
        - Key exchange methods
        - Encryption ciphers
        - MAC algorithms
        - Host key types

metadata:
  phase: service_identification
  priority_range: 6-7
  tools_required:
    - nmap
    - nc (netcat)
    - whatweb (optional)
    - sslscan (optional)
    - testssl (optional)
    - enum4linux (optional)
    - ssh-audit (optional)
  notes: |
    Service identification is Phase 3 of penetration testing.

    IDENTIFICATION WORKFLOW:
    1. Port discovered → Banner grab (Priority 7)
    2. Service identified → NSE scripts (Priority 6)
    3. Specific service → Service-specific enumeration

    SERVICE-SPECIFIC TRIGGERS:
    - HTTP/HTTPS → Web fingerprinting → Web enumeration
    - SMB (139/445) → SMB enumeration → Share enumeration
    - SSH (22) → SSH algorithms → SSH enumeration
    - Databases → Database fingerprinting → DB enumeration
    - SSL/TLS → SSL analysis → Vulnerability checks

    BATCH OPTIMIZATION:
    - Banner grabs: Up to 100 services in parallel
    - NSE scripts: Up to 50 services in parallel
    - SSL scans: Up to 50 services in parallel

    OUTPUT PROCESSING:
    All identification steps update the service asset with:
    - service_type (e.g., "http", "ssh", "smb")
    - service_version (e.g., "OpenSSH 7.4")
    - service_product (e.g., "Apache httpd")
    - Additional protocol-specific properties
