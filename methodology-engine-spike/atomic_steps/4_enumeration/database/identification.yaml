# Database Service Identification Atomic Steps
# Phase: SERVICE_IDENTIFICATION (Priority: 7)
# Purpose: Identify database type and version

steps:
- id: service_identification_database_fingerprint
  name: Database Service Fingerprinting
  description: Identify database type and version
  phase: service_identification
  priority: 7
  trigger_conditions:
  - type: property_match
    asset_type: service
    property_name: port
    property_pattern: (1433|3306|5432|1521|27017|6379|9200|9042)
    description: Common database ports
  - type: property_null
    asset_type: service
    property_name: database_type
  commands:
  - tool: nmap
    platforms:
    - linux
    - macos
    command: nmap -p {port} -sV --script=banner -oX {output_dir}/nmap_db_{host_safe}_{port}.xml {host}
    preferred: true
    timeout: 60
    requires_elevation: false
    notes: Database service version detection
  output_parser:
    type: nmap_xml
    updates_asset:
      properties:
        service_type: '{port.service.name}'
        database_type: '{port.service.product}'
        database_version: '{port.service.version}'
  deduplication_signature_fields:
  - host
  - port
  batch_compatible: true
  max_batch_size: 100
  cooldown_seconds: 3600
  next_step_ids: []
  metadata:
    mitre_attack: T1046
    notes: 'Database identification for common systems:

      - MySQL/MariaDB: 3306

      - PostgreSQL: 5432

      - MSSQL: 1433

      - Oracle: 1521

      - MongoDB: 27017

      - Redis: 6379

      - Elasticsearch: 9200

      - Cassandra: 9042

      '
metadata:
  category: Database Identification
  phase: service_identification
  priority_range: '7'
  tools_required:
  - nmap
  notes: 'Database service fingerprinting for common RDBMS and NoSQL systems.

    Identifies MySQL, PostgreSQL, MSSQL, MongoDB, Redis, Elasticsearch, etc.'
