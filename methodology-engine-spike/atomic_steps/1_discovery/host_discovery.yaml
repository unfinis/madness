# Host Discovery Atomic Steps
# Phase: DISCOVERY (Priority: 10)
# Purpose: Discover live hosts on networks using various techniques

steps:
  - id: host_discovery_icmp_ping_sweep
    name: "ICMP Ping Sweep Discovery"
    description: "Discover live hosts using ICMP echo requests (ping)"
    phase: discovery
    priority: 10

    trigger_conditions:
      - type: asset_created
        asset_type: network_segment
        description: "Triggers when a new network segment is added"
      - type: property_not_null
        asset_type: network_segment
        property_name: cidr
        description: "Requires CIDR notation for the network"

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sn -PE -oX {output_dir}/nmap_ping_sweep_{cidr_safe}.xml {cidr}"
        preferred: true
        timeout: 300
        requires_elevation: false
        notes: "ICMP echo (ping) sweep - most common, works when ICMP allowed"

      - tool: fping
        platforms: [linux, macos]
        command: "fping -a -g {cidr} 2>/dev/null > {output_dir}/fping_{cidr_safe}.txt"
        preferred: false
        timeout: 300
        requires_elevation: false
        notes: "Faster parallel ping sweep, less detailed output"

    output_parser:
      type: nmap_xml
      creates_assets:
        - asset_type: host
          conditions:
            - host_status: up
          properties:
            ip: "{host.address}"
            hostname: "{host.hostnames[0]}"
            state: "up"
            mac_address: "{host.mac}"
            vendor: "{host.vendor}"

    deduplication_signature_fields: [cidr]
    batch_compatible: false
    cooldown_seconds: 3600
    next_step_ids: [port_scan_quick_top_ports]

    metadata:
      mitre_attack: T1046
      references:
        - https://nmap.org/book/host-discovery.html
      notes: |
        ICMP ping sweep is the most basic host discovery technique.
        May be blocked by firewalls or host-based firewalls.
        Modern Windows (10+) blocks ICMP by default.

  - id: host_discovery_arp_scan
    name: "ARP Scan Discovery (Local Network)"
    description: "Discover hosts on local network using ARP requests"
    phase: discovery
    priority: 10

    trigger_conditions:
      - type: asset_created
        asset_type: network_segment
        description: "Triggers when a new network segment is added"
      - type: property_not_null
        asset_type: network_segment
        property_name: cidr

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sn -PR -oX {output_dir}/nmap_arp_scan_{cidr_safe}.xml {cidr}"
        preferred: true
        timeout: 300
        requires_elevation: true
        notes: "ARP scan - most reliable for local networks, requires root"

      - tool: arp-scan
        platforms: [linux]
        command: "arp-scan --interface={interface} {cidr} -x > {output_dir}/arp_scan_{cidr_safe}.xml"
        preferred: false
        timeout: 300
        requires_elevation: true
        notes: "Dedicated ARP scanning tool, very fast and reliable"

      - tool: netdiscover
        platforms: [linux]
        command: "netdiscover -r {cidr} -P > {output_dir}/netdiscover_{cidr_safe}.txt"
        preferred: false
        timeout: 300
        requires_elevation: true
        notes: "Active/passive ARP reconnaissance tool"

    output_parser:
      type: nmap_xml
      creates_assets:
        - asset_type: host
          conditions:
            - host_status: up
          properties:
            ip: "{host.address}"
            state: "up"
            mac_address: "{host.mac}"
            vendor: "{host.vendor}"
            discovery_method: "arp"

    deduplication_signature_fields: [cidr]
    batch_compatible: false
    cooldown_seconds: 3600
    next_step_ids: [port_scan_quick_top_ports]

    metadata:
      mitre_attack: T1046
      references:
        - https://nmap.org/book/host-discovery.html
      notes: |
        ARP scan is the most reliable method for local network discovery.
        Only works on the same subnet (Layer 2).
        Cannot be blocked by firewalls (operates at Layer 2).
        Requires root/admin privileges.

  - id: host_discovery_tcp_syn
    name: "TCP SYN Discovery"
    description: "Discover hosts using TCP SYN packets to common ports"
    phase: discovery
    priority: 10

    trigger_conditions:
      - type: asset_created
        asset_type: network_segment
      - type: property_not_null
        asset_type: network_segment
        property_name: cidr

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sn -PS22,80,443,3389,445 -oX {output_dir}/nmap_tcp_syn_discovery_{cidr_safe}.xml {cidr}"
        preferred: true
        timeout: 600
        requires_elevation: true
        notes: "TCP SYN to common ports - works when ICMP blocked"

      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sn -PS1-1024 -oX {output_dir}/nmap_tcp_syn_all_wellknown_{cidr_safe}.xml {cidr}"
        preferred: false
        timeout: 1800
        requires_elevation: true
        notes: "TCP SYN to all well-known ports (1-1024) - slower but comprehensive"

    output_parser:
      type: nmap_xml
      creates_assets:
        - asset_type: host
          conditions:
            - host_status: up
          properties:
            ip: "{host.address}"
            hostname: "{host.hostnames[0]}"
            state: "up"
            discovery_method: "tcp_syn"

    deduplication_signature_fields: [cidr]
    batch_compatible: false
    cooldown_seconds: 3600
    next_step_ids: [port_scan_quick_top_ports]

    metadata:
      mitre_attack: T1046
      references:
        - https://nmap.org/book/host-discovery-techniques.html
      notes: |
        TCP SYN discovery is effective when ICMP is blocked.
        Targets common service ports (SSH, HTTP, HTTPS, RDP, SMB).
        May trigger IDS/IPS alerts.
        Requires root for raw packet access.

  - id: host_discovery_udp
    name: "UDP Discovery"
    description: "Discover hosts using UDP packets to common ports"
    phase: discovery
    priority: 10

    trigger_conditions:
      - type: asset_created
        asset_type: network_segment
      - type: property_not_null
        asset_type: network_segment
        property_name: cidr

    commands:
      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sn -PU53,161,137 -oX {output_dir}/nmap_udp_discovery_{cidr_safe}.xml {cidr}"
        preferred: true
        timeout: 600
        requires_elevation: true
        notes: "UDP discovery to DNS, SNMP, NetBIOS ports"

    output_parser:
      type: nmap_xml
      creates_assets:
        - asset_type: host
          conditions:
            - host_status: up
          properties:
            ip: "{host.address}"
            hostname: "{host.hostnames[0]}"
            state: "up"
            discovery_method: "udp"

    deduplication_signature_fields: [cidr]
    batch_compatible: false
    cooldown_seconds: 3600
    next_step_ids: [port_scan_quick_top_ports]

    metadata:
      mitre_attack: T1046
      references:
        - https://nmap.org/book/host-discovery-techniques.html
      notes: |
        UDP discovery targets common UDP services.
        Less reliable than TCP (stateless protocol).
        Useful when TCP is heavily filtered.

metadata:
  category: Host Discovery
  phase: discovery
  priority_range: 10
  tools_required:
    - nmap
    - fping (optional)
    - arp-scan (optional)
    - netdiscover (optional)
  notes: |
    Host discovery is the first stage of network reconnaissance.
    Multiple techniques should be used for comprehensive coverage.

    TECHNIQUE SELECTION:
    - Local network: ARP scan (most reliable)
    - ICMP allowed: Ping sweep (fastest)
    - ICMP blocked: TCP SYN discovery
    - Stealth required: TCP SYN with careful timing

    All discovery methods trigger port scanning on discovered hosts.
