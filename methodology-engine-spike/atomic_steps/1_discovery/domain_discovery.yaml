# Domain Discovery Atomic Steps
# Phase: DISCOVERY (Priority: 9-10)
# Purpose: Discover hosts and subdomains through DNS-based techniques

steps:
  - id: host_discovery_dns_reverse_lookup
    name: "DNS Reverse Lookup Discovery"
    description: "Enumerate hosts by reverse DNS lookups of IP range"
    phase: discovery
    priority: 9

    trigger_conditions:
      - type: asset_created
        asset_type: network_segment
        description: "Triggers when a new network segment is added"
      - type: property_not_null
        asset_type: network_segment
        property_name: cidr

    commands:
      - tool: bash
        platforms: [linux, macos]
        command: |
          for ip in $(nmap -sL {cidr} | grep 'scan report' | awk '{print $NF}' | tr -d '()'); do
            hostname=$(host $ip 2>/dev/null | grep 'domain name pointer' | awk '{print $NF}' | sed 's/\.$//');
            if [ ! -z "$hostname" ]; then
              echo "$ip,$hostname" >> {output_dir}/reverse_dns_{cidr_safe}.csv;
            fi;
          done
        preferred: true
        timeout: 900
        requires_elevation: false
        notes: "Reverse DNS lookup for all IPs in range"

      - tool: nmap
        platforms: [linux, macos]
        command: "nmap -sL -oX {output_dir}/nmap_dns_lookup_{cidr_safe}.xml {cidr}"
        preferred: false
        timeout: 600
        requires_elevation: false
        notes: "Nmap list scan with DNS resolution"

    output_parser:
      type: csv
      creates_assets:
        - asset_type: host
          properties:
            ip: "{column[0]}"
            hostname: "{column[1]}"
            discovery_method: "reverse_dns"

    deduplication_signature_fields: [cidr]
    batch_compatible: false
    cooldown_seconds: 3600
    next_step_ids: []

    metadata:
      mitre_attack: T1046
      references:
        - https://book.hacktricks.xyz/generic-methodologies-and-resources/pentesting-network
      notes: |
        Reverse DNS lookups are passive and don't alert the target.
        May reveal internal naming conventions and server purposes.
        Not all IPs have reverse DNS entries.
        Very useful for reconnaissance phase.

  - id: host_discovery_dns_zone_transfer
    name: "DNS Zone Transfer Enumeration"
    description: "Attempt DNS zone transfer to enumerate all hosts in domain"
    phase: discovery
    priority: 10

    trigger_conditions:
      - type: asset_created
        asset_type: domain
        description: "Triggers when a domain asset is added"
      - type: property_not_null
        asset_type: domain
        property_name: domain_name

    commands:
      - tool: dig
        platforms: [linux, macos]
        command: "dig axfr @{nameserver} {domain_name} > {output_dir}/zone_transfer_{domain_name_safe}.txt"
        preferred: true
        timeout: 60
        requires_elevation: false
        notes: "Attempt zone transfer with dig"

      - tool: host
        platforms: [linux, macos]
        command: "host -l {domain_name} {nameserver} > {output_dir}/zone_transfer_host_{domain_name_safe}.txt"
        preferred: false
        timeout: 60
        requires_elevation: false
        notes: "Attempt zone transfer with host command"

      - tool: nmap
        platforms: [linux, macos]
        command: "nmap --script dns-zone-transfer --script-args dns-zone-transfer.domain={domain_name} -p 53 {nameserver}"
        preferred: false
        timeout: 120
        requires_elevation: false
        notes: "Nmap DNS zone transfer script"

    output_parser:
      type: regex
      patterns:
        hostname: "^([a-zA-Z0-9.-]+)\\s+IN\\s+A\\s+([0-9.]+)"
      creates_assets:
        - asset_type: host
          properties:
            hostname: "{match.group[1]}"
            ip: "{match.group[2]}"
            discovery_method: "zone_transfer"
            domain: "{domain_name}"

    deduplication_signature_fields: [domain_name, nameserver]
    batch_compatible: true
    max_batch_size: 50
    cooldown_seconds: 7200
    next_step_ids: [port_scan_quick_top_ports]

    metadata:
      mitre_attack: T1590
      cvss_score: 5.3
      references:
        - https://book.hacktricks.xyz/network-services-pentesting/pentesting-dns
      notes: |
        DNS zone transfer (AXFR) is a critical misconfiguration.
        Exposes complete list of subdomains and hosts.
        Should always be tested on discovered DNS servers.
        Most production DNS servers block zone transfers.

  - id: host_discovery_subdomain_enumeration
    name: "Subdomain Enumeration"
    description: "Enumerate subdomains through various techniques"
    phase: discovery
    priority: 9

    trigger_conditions:
      - type: asset_created
        asset_type: domain
      - type: property_not_null
        asset_type: domain
        property_name: domain_name

    commands:
      - tool: sublist3r
        platforms: [linux, macos]
        command: "sublist3r -d {domain_name} -o {output_dir}/sublist3r_{domain_name_safe}.txt"
        preferred: true
        timeout: 300
        requires_elevation: false
        notes: "Subdomain enumeration via search engines and brute force"

      - tool: amass
        platforms: [linux, macos]
        command: "amass enum -passive -d {domain_name} -o {output_dir}/amass_{domain_name_safe}.txt"
        preferred: false
        timeout: 600
        requires_elevation: false
        notes: "Comprehensive subdomain enumeration (passive mode)"

      - tool: subfinder
        platforms: [linux, macos]
        command: "subfinder -d {domain_name} -o {output_dir}/subfinder_{domain_name_safe}.txt"
        preferred: false
        timeout: 300
        requires_elevation: false
        notes: "Fast passive subdomain discovery"

      - tool: dnsrecon
        platforms: [linux, macos]
        command: "dnsrecon -d {domain_name} -t std -x {output_dir}/dnsrecon_{domain_name_safe}.xml"
        preferred: false
        timeout: 300
        requires_elevation: false
        notes: "DNS enumeration and zone transfer attempts"

    output_parser:
      type: regex
      patterns:
        subdomain: "^([a-zA-Z0-9.-]+\\.{domain_name})$"
      creates_assets:
        - asset_type: host
          properties:
            hostname: "{match.group[1]}"
            discovery_method: "subdomain_enum"
            parent_domain: "{domain_name}"

    deduplication_signature_fields: [domain_name]
    batch_compatible: true
    max_batch_size: 20
    cooldown_seconds: 7200
    next_step_ids: [dns_record_enumeration]

    metadata:
      mitre_attack: T1590
      references:
        - https://github.com/OWASP/Amass
        - https://github.com/aboul3la/Sublist3r
      notes: |
        Subdomain enumeration is crucial for expanding attack surface.
        Combines multiple data sources (certificate transparency, search engines, DNS).
        May take significant time for large domains.
        Consider rate limiting to avoid detection.

metadata:
  category: Domain Discovery
  phase: discovery
  priority_range: 9-10
  tools_required:
    - dig
    - host
    - nmap
    - sublist3r (optional)
    - amass (optional)
    - subfinder (optional)
    - dnsrecon (optional)
  notes: |
    DNS-based discovery is often passive and less likely to trigger alerts.

    TECHNIQUE SELECTION:
    - Zone transfer: Test all discovered DNS servers
    - Reverse DNS: Passive reconnaissance of IP ranges
    - Subdomain enum: Essential for web application testing

    Discovered hosts trigger subsequent port scanning and enumeration.
